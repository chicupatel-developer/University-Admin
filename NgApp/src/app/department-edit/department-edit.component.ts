import { ActivatedRoute, Router } from '@angular/router';
import { Component, OnInit } from '@angular/core';
import { DataService } from '../services/data.service';
import Department from '../models/department';
import { Observable } from 'rxjs';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { LocalDataService } from '../services/local-data.service';

@Component({
  selector: 'app-department-edit',
  templateUrl: './department-edit.component.html',
  styleUrls: ['./department-edit.component.css']
})
export class DepartmentEditComponent implements OnInit {

  // can't change
  // only departmentname can be edited
  departmentId: string;

  deptForm: FormGroup;
  submitted = false;
  departmentModel = new Department();

  editDeptPanel = true;

  apiResponse = '';
  responseColor = '';
  errors: string[];

  constructor(public localDataService: LocalDataService, private fb: FormBuilder, public dataService: DataService, private router: Router, private route: ActivatedRoute)
  { }

  // ok
  ngOnInit(): void {
    this.deptForm = this.fb.group({
      DepartmentName: ['', Validators.required]
    })

    
    this.departmentId = this.route.snapshot.paramMap.get('id');
    if (isNaN(+this.departmentId)) {
      console.log('Not a Number!');
      this.router.navigate(['/department']);
    }
    else {
      // do api call to retrieve latest department information 
      this.dataService.getDepartment(Number(this.departmentId))
        .subscribe(
          data => {
            if(data==null){
              console.log('department not found!');
              this.editDeptPanel = false;
              // fail
              // display error message
              this.apiResponse = 'Department Not Found!';
              this.responseColor = 'red';
            }
            else{
              this.apiResponse = '';
              this.responseColor = 'green';
              this.editDeptPanel = true;

              console.log(data);
              // popup form data with incoming api data call          
              this.deptForm.setValue({
                DepartmentName: data.departmentName
              });
            }
          },
          error => {
            console.log(error);
          });
    }
  }

  // ok
  get deptFormControl() {
    return this.deptForm.controls;
  }

  // ok
  onSubmit(): void {
    this.responseColor = '';
    this.errors = [];    
    this.apiResponse = '';

    this.submitted = true;
    if (this.deptForm.valid) {
      this.departmentModel.departmentName = this.deptForm.value["DepartmentName"];
      // this.departmentModel.departmentName = null;
      this.departmentModel.departmentId = Number(this.departmentId);

      this.dataService.editDept(this.departmentModel)
        .subscribe(
          response => {
            // 0
            if (response.responseCode === 0) {
              // success
              this.apiResponse = response.responseMessage;
              this.responseColor = 'green';
              this.editDeptPanel = false;  
              
              // redirect to department component
              setTimeout(() => {
                this.router.navigate(['/department']);
              }, 3000);
            }
            // -1
            else {
              // fail
              // display error message
              this.apiResponse = response.responseCode + ' : ' + response.responseMessage;
              this.responseColor = 'red';
              this.editDeptPanel = true;
            }
          },
          error => {
            this.apiResponse = '';
            this.responseColor = 'red';
            this.editDeptPanel = true;
            // 400
            // ModelState @api
            if (error.status === 400) {   
              this.errors = this.localDataService.display400andEx(error, 'Registration');      
            }
            else {
              console.log(error);
            }
          }
        );
    }
  }

  // ok
  resetDept(){
    this.apiResponse = '';
    this.responseColor = '';
    this.errors = [];  
    this.deptForm.reset();
    this.submitted = false;

    this.router.navigate(['/department']);
  }
}
